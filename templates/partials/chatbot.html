<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Casa en el Árbol - Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
</head>
<body>
    <div class="container-fluid p-0">
        <!-- Header simple para la demo -->
        <div class="header-demo">
            <div class="container">
                <div class="d-flex justify-content-between align-items-center py-3">
                    <h2 class="logo">
                        <i class="bi bi-house-heart me-2"></i>
                        Casa en el Árbol
                    </h2>
                    <div class="header-info">
                        <span class="badge bg-success">Chat en tiempo real</span>
                        <span class="text-muted ms-2">Conectado: <span id="connectedUsers">0</span> usuarios</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área principal del chat -->
        <div class="chat-main-container">
            <div class="container">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <!-- Chat Container -->
                        <div class="chat-container-main" id="chatContainer">
                            <!-- Header del chat -->
                            <div class="chat-header">
                                <div class="chat-status">
                                    <div class="chat-avatar">
                                        <i class="bi bi-robot"></i>
                                    </div>
                                    <div class="chat-info">
                                        <h4>Asistente Casa en el Árbol</h4>
                                        <p><span class="status-indicator" id="connectionStatus"></span><span id="statusText">Conectando...</span></p>
                                    </div>
                                    <div class="chat-controls">
                                        <button class="btn btn-sm btn-outline-light" onclick="clearChat()" title="Limpiar chat">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-light" onclick="exportChat()" title="Exportar conversación">
                                            <i class="bi bi-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Cuerpo del chat -->
                            <div class="chat-body" id="chatBody">
                                <!-- Los mensajes se cargarán aquí dinámicamente -->
                                
                                <!-- Indicador de escritura -->
                                <div class="typing-indicator" id="typingIndicator">
                                    <div class="message-avatar">
                                        <i class="bi bi-robot"></i>
                                    </div>
                                    <div class="message-content">
                                        <div class="typing-dots">
                                            <div class="typing-dot"></div>
                                            <div class="typing-dot"></div>
                                            <div class="typing-dot"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Respuestas rápidas -->
                            <div class="quick-replies" id="quickReplies">
                                <!-- Las respuestas rápidas se cargarán dinámicamente -->
                            </div>

                            <!-- Input del chat -->
                            <div class="chat-input-container">
                                <div class="chat-input-group">
                                    <textarea 
                                        class="chat-input" 
                                        id="chatInput" 
                                        placeholder="Escribe tu mensaje aquí..." 
                                        rows="1"
                                        maxlength="500"
                                    ></textarea>
                                    <button class="chat-send-btn" id="chatSendBtn" onclick="sendMessage()" disabled>
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                                <div class="chat-input-info">
                                    <small class="text-muted">
                                        <span id="charCount">0</span>/500 caracteres
                                        | Presiona Enter para enviar, Shift+Enter para nueva línea
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast para notificaciones -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="notificationToast" class="toast" role="alert">
            <div class="toast-header">
                <i class="bi bi-chat-square-dots text-primary me-2"></i>
                <strong class="me-auto">Casa en el Árbol</strong>
                <small class="text-muted" id="toastTime"></small>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toastBody">
                <!-- Contenido del toast -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
    
    <script>
        // Variables globales
        let socket;
        let isConnected = false;
        let sessionId = null;
        let messageHistory = [];

        // Inicializar cuando cargue la página
        document.addEventListener('DOMContentLoaded', function() {
            initializeChat();
        });

        function initializeChat() {
            // Conectar al servidor de WebSocket
            socket = io();
            
            // Event listeners del socket
            socket.on('connect', function() {
                isConnected = true;
                sessionId = socket.id;
                updateConnectionStatus(true);
                console.log('Conectado al servidor de chat');
            });

            socket.on('disconnect', function() {
                isConnected = false;
                updateConnectionStatus(false);
                console.log('Desconectado del servidor de chat');
            });

            socket.on('bot_message', function(data) {
                addMessageToChat(data.text, 'bot', data.timestamp);
                
                if (data.quick_replies && data.quick_replies.length > 0) {
                    updateQuickReplies(data.quick_replies);
                }
                
                if (data.suggestions && data.suggestions.length > 0) {
                    // Agregar sugerencias si las hay
                    console.log('Sugerencias:', data.suggestions);
                }
            });

            socket.on('typing_start', function() {
                showTypingIndicator();
            });

            socket.on('typing_stop', function() {
                hideTypingIndicator();
            });

            // Configurar input del chat
            setupChatInput();
        }

        function updateConnectionStatus(connected) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            const sendBtn = document.getElementById('chatSendBtn');
            
            if (connected) {
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'En línea - Respuesta inmediata';
                sendBtn.disabled = false;
            } else {
                statusIndicator.className = 'status-indicator disconnected';
                statusText.textContent = 'Desconectado - Reconectando...';
                sendBtn.disabled = true;
            }
        }

        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('chatSendBtn');
            const charCount = document.getElementById('charCount');

            // Auto-resize del textarea
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                
                // Actualizar contador de caracteres
                const count = this.value.length;
                charCount.textContent = count;
                
                // Habilitar/deshabilitar botón de envío
                sendBtn.disabled = !isConnected || count === 0 || count > 500;
                
                if (count > 450) {
                    charCount.className = 'text-warning';
                } else if (count > 500) {
                    charCount.className = 'text-danger';
                } else {
                    charCount.className = 'text-muted';
                }
            });

            // Manejar Enter y Shift+Enter
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && isConnected) {
                // Agregar mensaje del usuario al chat
                addMessageToChat(message, 'user');
                
                // Enviar mensaje al servidor
                socket.emit('user_message', { message: message });
                
                // Limpiar input
                input.value = '';
                input.style.height = 'auto';
                document.getElementById('charCount').textContent = '0';
                document.getElementById('chatSendBtn').disabled = true;
                
                // Limpiar respuestas rápidas
                updateQuickReplies([]);
            }
        }

        function sendQuickReply(reply) {
            if (isConnected) {
                // Agregar como mensaje del usuario
                addMessageToChat(reply, 'user');
                
                // Enviar al servidor
                socket.emit('quick_reply', { reply: reply });
                
                // Limpiar respuestas rápidas
                updateQuickReplies([]);
            }
        }

        function addMessageToChat(message, sender, timestamp = null) {
            const chatBody = document.getElementById('chatBody');
            const typingIndicator = document.getElementById('typingIndicator');
            const now = timestamp || new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            if (sender === 'bot') {
                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="bi bi-robot"></i>
                    </div>
                    <div class="message-wrapper">
                        <div class="message-content">${formatMessage(message)}</div>
                        <div class="message-time">${now}</div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-wrapper">
                        <div class="message-content">${formatMessage(message)}</div>
                        <div class="message-time">${now}</div>
                    </div>
                `;
            }
            
            // Insertar antes del indicador de escritura
            chatBody.insertBefore(messageDiv, typingIndicator);
            
            // Scroll al final
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Guardar en historial
            messageHistory.push({ message, sender, timestamp: now });
        }

        function formatMessage(message) {
            // Formatear markdown básico
            return message
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/~~(.*?)~~/g, '<del>$1</del>')
                .replace(/\n/g, '<br>');
        }

        function updateQuickReplies(replies) {
            const container = document.getElementById('quickReplies');
            container.innerHTML = '';
            
            replies.forEach(reply => {
                const button = document.createElement('button');
                button.className = 'quick-reply-btn';
                button.textContent = reply;
                button.onclick = () => sendQuickReply(reply);
                container.appendChild(button);
            });
        }

        function showTypingIndicator() {
            document.getElementById('typingIndicator').classList.add('show');
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        function hideTypingIndicator() {
            document.getElementById('typingIndicator').classList.remove('show');
        }

        function clearChat() {
            if (confirm('¿Estás seguro de que quieres limpiar la conversación?')) {
                const chatBody = document.getElementById('chatBody');
                const typingIndicator = document.getElementById('typingIndicator');
                
                // Mantener solo el indicador de escritura
                chatBody.innerHTML = '';
                chatBody.appendChild(typingIndicator);
                
                // Limpiar respuestas rápidas
                updateQuickReplies([]);
                
                // Limpiar historial
                messageHistory = [];
                
                // Notificar al servidor si es necesario
                if (isConnected && sessionId) {
                    fetch(`/api/chat/clear/${sessionId}`, { method: 'POST' });
                }
                
                showToast('Conversación limpiada', 'La conversación se ha reiniciado correctamente.');
            }
        }

        function exportChat() {
            if (messageHistory.length === 0) {
                showToast('Sin mensajes', 'No hay conversación para exportar.');
                return;
            }
            
            const chatData = {
                session_id: sessionId,
                export_timestamp: new Date().toISOString(),
                messages: messageHistory,
                total_messages: messageHistory.length
            };
            
            const blob = new Blob([JSON.stringify(chatData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `chat-casa-arbol-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Exportado', 'Conversación exportada correctamente.');
        }

        function showToast(title, message) {
            const toastElement = document.getElementById('notificationToast');
            const toastBody = document.getElementById('toastBody');
            const toastTime = document.getElementById('toastTime');
            
            toastBody.textContent = message;
            toastTime.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // Detectar cuando el usuario está escribiendo (para futuras funcionalidades)
        let typingTimeout;
        document.getElementById('chatInput').addEventListener('input', function() {
            clearTimeout(typingTimeout);
            
            // Aquí podrías emitir un evento de "usuario escribiendo"
            // socket.emit('user_typing', { typing: true });
            
            typingTimeout = setTimeout(() => {
                // socket.emit('user_typing', { typing: false });
            }, 1000);
        });

        // Notificaciones del navegador (opcional)
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function showBrowserNotification(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: body,
                    icon: '/static/favicon.ico',
                    tag: 'chatbot-notification'
                });
            }
        }

        // Solicitar permisos de notificación después de 3 segundos
        setTimeout(requestNotificationPermission, 3000);

        // Manejar visibilidad de la página para notificaciones
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // La página está oculta, habilitar notificaciones para nuevos mensajes
                window.chatNotificationsEnabled = true;
            } else {
                // La página está visible, deshabilitar notificaciones
                window.chatNotificationsEnabled = false;
            }
        });
    </script>
</body>
</html>